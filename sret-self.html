<!DOCTYPE html>

<!--
  This version of the Self-Referent Encoding Task (SRET; Derry & Kuiper, 1981) is being used for the dissertation study of Rachel Weisenburger of the Mood Disorders Lab at UT Austin, entitled: "Depression and the Self: A Longitudinal Examination of Biased Self-Schema and Depression Symptom Dimensions." Code is adapted based on the programming of Dr. Justin Dainer-Best of the Bard College Affective Science Lab, https://affectlab.bard.edu. Incorporates the case trial condition and stimuli words from Hitchcock et al., 2023 (doi.org/10.3758/s13415-022-01033-9) and Alejandre-Lara et al., 2021 (doi.org/10.1007/s10608-021-10287-5).
-->

<html>
  <head>
    <title>Task</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
           integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
           crossorigin="anonymous"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-browser-check.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#dddddd">
  </head>
  <body></body>

<script>
// data.trials[1].session ==> the session
// data.trials[1].ppt ==> the participant ID -- the [1] just grabs it from the second trial

var taskStartTime = Date.now() // recording start time
    
/* initialize jsPsych task */
const jsPsych = initJsPsych({
  use_webaudio: false,
  on_finish: function(data) {
    var ppt = data.trials[1].ppt;
    var event = data.trials[1].event; // "w0_arm_1", "w2_arm_1", etc.
    var finalurl = data.trials[1].rc; // redcap survey access code
    
    if (finalurl) {
          finalurl = 'https://redcap.prc.utexas.edu/redcap/surveys/?code=' + finalurl + '&'
        }
    
    // Construct the return URL with all parameters
    // redcap url: https://sret-self-4774526bcb1e.herokuapp.com/?sret_id=[record-name]&sret_session=[event-name]&sret_arm=[arm-num]&rc=[event-name][survey-access-code:postsret_w0] // w0, w2, etc
    
    var newurlgo = `${finalurl}sret_id=${ppt}&sret_event=${event}`
    
   /* `${finalurl}sret_id=${ppt}&sret_session=${session}` */
    
    // Post experiment data to server
    var jqxhr = $.post({
      url: "/experiment-data",
      data: JSON.stringify(data),
      contentType: "application/json"
    })
    .done(function(data) {
      if(finalurl) {
        window.location.href = newurlgo;
      } else {
        // Error handling if no redirect URL
        document.write('<!DOCTYPE html><html><body><div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%;"><h1>Missing redirect</h1><p>This page cannot redirect you as expected. Please be sure that you followed the correct link. While your data has been recorded, you will not be redirected to finish data collection for today. You do not need to complete the task again, but may contact the researchers if you have questions.</p></div></body></html>')
      }
    })
    .fail(function() {
      // Redirect even if POST fails
      window.location.href = newurlgo;
    })
  }
});

const timeline = []

/* get URL variables */
var urlvar = jsPsych.data.urlVariables();

jsPsych.data.addProperties({
  ppt: urlvar.sret_id,
  event: urlvar.sret_event,
  sona_id: urlvar.sona_id || null, // sona_id for SONA sample, null for main sample
  rc: urlvar.rc
});
        
/* check to confirm that they're on mobile */
const checkMobile = {
  type: jsPsychBrowserCheck,
  features: ["mobile", "browser"],
};
    
//timeline.push(checkMobile);

const notifyMobile = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%; font-size: 1em; line-height: 1.2em;">
    <p>We recommend that you participate on a mobile device. If you are on a desktop or laptop, you may want to switch to your smartphone or tablet.</p>
    <p>(You can right click and copy <a href="${window.location.href}">the URL</a> from this tab to your phone.)</p>
    </div>
    `,
    choices: ['Continue'],
    button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
    margin_vertical: '50px',
};

var if_mobile = {
    timeline: [notifyMobile],
    conditional_function: function(){
        // get the data from the previous trial,
        // and check whether it's mobile or not
        var data = jsPsych.data.get().last(1).values()[0];
        // change CSS for fonts based on device:
        if(!data.mobile) {
          // Desktop/laptop: use smaller font
          $('.jspsych-display-element').css('font-size', '1.5em')
          $('.jspsych-display-element').css('line-height', '1.7em')
        } else {
          // Mobile: use larger font
          $('.jspsych-display-element').css('font-size', '2.5em')
          $('.jspsych-display-element').css('line-height', '2em')
        }
        return(!data.mobile)
    }
}

timeline.push(checkMobile, if_mobile);

/* Stimuli Setup */

/* practice trials */
const practice_stimuli = [
  {stimulus: 'TALL', word: 'TALL', trialtype: 'practice', valence: 'null', cue: 'self?'},
  {stimulus: 'young', word: 'young', trialtype: 'practice', valence: 'null', cue: 'caps?'},
  {stimulus: 'strong', word: 'strong', trialtype: 'practice', valence: 'null', cue: 'self?'},
  {stimulus: 'SORE', word: 'SORE', trialtype: 'practice', valence: 'null', cue: 'caps?'},
  {stimulus: "cold", word: 'cold', trialtype: 'practice', valence: 'null', cue: 'self?'},
  {stimulus: "full", word: 'full', trialtype: 'practice', valence: 'null', cue: 'caps?'}
];

const practice_stimuli_second_round = [
  {stimulus: 'short', word: 'short', trialtype: 'practice2', valence: 'null', cue: 'caps?'},
  {stimulus: 'LITTLE', word: 'LITTLE', trialtype: 'practice2', valence: 'null', cue: 'self?'},
  {stimulus: 'STUDENT', word: 'STUDENT', trialtype: 'practice2', valence: 'null', cue: 'caps?'},
  {stimulus: 'sibling', word: 'sibling', trialtype: 'practice2', valence: 'null', cue: 'self?'},
  {stimulus: 'warm', word: 'warm', trialtype: 'practice2', valence: 'null', cue: 'caps?'},
  {stimulus: 'single', word: 'single', trialtype: 'practice2', valence: 'null', cue: 'self?'}
];

const practice_stimuli_third_round = [
  {stimulus: 'QUIET', word: 'QUIET', trialtype: 'practice3', valence: 'null', cue: 'caps?'},
  {stimulus: 'PROUD', word: 'PROUD', trialtype: 'practice3', valence: 'null', cue: 'self?'},
  {stimulus: 'hungry', word: 'hungry', trialtype: 'practice3', valence: 'null', cue: 'caps?'},
  {stimulus: 'married', word: 'married', trialtype: 'practice3', valence: 'null', cue: 'self?'},
  {stimulus: 'silly', word: 'silly', trialtype: 'practice3', valence: 'null', cue: 'caps?'},
  {stimulus: 'PARENT', word: 'PARENT', trialtype: 'practice3', valence: 'null', cue: 'self?'}
];

const w0_unique_stimuli = [
  {stimulus: 'successful', word: 'successful', trialtype: 'core', valence: 'positive', cue: 'self?'}, // first 30 stimuli = "core" stimuli
  {stimulus: 'terrific', word: 'terrific', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'funny', word: 'funny', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'intelligent', word: 'intelligent', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'amazing', word: 'amazing', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'entertaining', word: 'entertaining', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'fantastic', word: 'fantastic', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'wonderful', word: 'wonderful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'beautiful', word: 'beautiful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'happy', word: 'happy', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'great', word: 'great', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'loyal', word: 'loyal', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'cool', word: 'cool', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'joyful', word: 'joyful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'knowledgeable', word: 'knowledgeable', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'sad', word: 'sad', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'hostile', word: 'hostile', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'burdened', word: 'burdened', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'incompetent', word: 'incompetent', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'inconsiderate', word: 'inconsiderate', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'ashamed', word: 'ashamed', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'irresponsible', word: 'irresponsible', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'bored', word: 'bored', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'mad', word: 'mad', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'lonely', word: 'lonely', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'worried', word: 'worried', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'anguished', word: 'anguished', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'fearful', word: 'fearful', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'angry', word: 'angry', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'disloyal', word: 'disloyal', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'lovable', word: 'lovable', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'glad', word: 'glad', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'nice', word: 'nice', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'satisfied', word: 'satisfied', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'thoughtful', word: 'thoughtful', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'devoted', word: 'devoted', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'capable', word: 'capable', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'handsome', word: 'handsome', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'excellent', word: 'excellent', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'excited', word: 'excited', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'useful', word: 'useful', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'sexy', word: 'sexy', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'extraordinary', word: 'extraordinary', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'grateful', word: 'grateful', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'inspired', word: 'inspired', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'dignified', word: 'dignified', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'engaged', word: 'engaged', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'bold', word: 'bold', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'honest', word: 'honest', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'gentle', word: 'gentle', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'charming', word: 'charming', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'likeable', word: 'likeable', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'appreciative', word: 'appreciative', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'resourceful', word: 'resourceful', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'loved', word: 'loved', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'dreadful', word: 'dreadful', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'disgusted', word: 'disgusted', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'horrible', word: 'horrible', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'lost', word: 'lost', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'annoyed', word: 'annoyed', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'afraid', word: 'afraid', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'heartbroken', word: 'heartbroken', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'weak', word: 'weak', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'brokenhearted', word: 'brokenhearted', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'scared', word: 'scared', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'useless', word: 'useless', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'troubled', word: 'troubled', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'disgraceful', word: 'disgraceful', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'rude', word: 'rude', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'dishonorable', word: 'dishonorable', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'insecure', word: 'insecure', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'alone', word: 'alone', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'terrible', word: 'terrible', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'cruel', word: 'cruel', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'unlucky', word: 'unlucky', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'vigorous', word: 'vigorous', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'adorable', word: 'adorable', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'outstanding', word: 'outstanding', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'confident', word: 'confident', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'fun', word: 'fun', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'courageous', word: 'courageous', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'unique', word: 'unique', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'optimistic', word: 'optimistic', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'admired', word: 'admired', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'skillful', word: 'skillful', trialtype: 'novel1', valence: 'positive', cue: 'self?'},
  {stimulus: 'hateful', word: 'hateful', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'heartless', word: 'heartless', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'egotistical', word: 'egotistical', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'unsociable', word: 'unsociable', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'pessimistic', word: 'pessimistic', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'stupid', word: 'stupid', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'unattractive', word: 'unattractive', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'unwanted', word: 'unwanted', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'dumb', word: 'dumb', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'sorry', word: 'sorry', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'neglectful', word: 'neglectful', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'foolish', word: 'foolish', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'boring', word: 'boring', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'sloppy', word: 'sloppy', trialtype: 'novel1', valence: 'negative', cue: 'self?'},
  {stimulus: 'thoughtless', word: 'thoughtless', trialtype: 'novel1', valence: 'negative', cue: 'self?'}
]


const w2_unique_stimuli = [
  {stimulus: 'successful', word: 'successful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'terrific', word: 'terrific', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'funny', word: 'funny', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'intelligent', word: 'intelligent', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'amazing', word: 'amazing', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'entertaining', word: 'entertaining', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'fantastic', word: 'fantastic', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'wonderful', word: 'wonderful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'beautiful', word: 'beautiful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'happy', word: 'happy', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'great', word: 'great', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'loyal', word: 'loyal', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'cool', word: 'cool', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'joyful', word: 'joyful', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'knowledgeable', word: 'knowledgeable', trialtype: 'core', valence: 'positive', cue: 'self?'},
  {stimulus: 'sad', word: 'sad', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'hostile', word: 'hostile', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'burdened', word: 'burdened', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'incompetent', word: 'incompetent', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'inconsiderate', word: 'inconsiderate', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'ashamed', word: 'ashamed', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'irresponsible', word: 'irresponsible', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'bored', word: 'bored', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'mad', word: 'mad', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'lonely', word: 'lonely', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'worried', word: 'worried', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'anguished', word: 'anguished', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'fearful', word: 'fearful', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'angry', word: 'angry', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'disloyal', word: 'disloyal', trialtype: 'core', valence: 'negative', cue: 'self?'},
  {stimulus: 'carefree', word: 'carefree', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'pleased', word: 'pleased', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'lucky', word: 'lucky', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'exciting', word: 'exciting', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'gorgeous', word: 'gorgeous', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'playful', word: 'playful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'hopeful', word: 'hopeful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'content', word: 'content', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'masterful', word: 'masterful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'helpful', word: 'helpful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'perceptive', word: 'perceptive', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'imaginative', word: 'imaginative', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'versatile', word: 'versatile', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'forgiving', word: 'forgiving', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'tactful', word: 'tactful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'tender', word: 'tender', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'cultured', word: 'cultured', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'courteous', word: 'courteous', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'amusing', word: 'amusing', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'creative', word: 'creative', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'vivacious', word: 'vivacious', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'energetic', word: 'energetic', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'romantic', word: 'romantic', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'honorable', word: 'honorable', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'humorous', word: 'humorous', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'warm-hearted', word: 'warm-hearted', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'sensible', word: 'sensible', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'earnest', word: 'earnest', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'sympathetic', word: 'sympathetic', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'polite', word: 'polite', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'witty', word: 'witty', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'enterprising', word: 'enterprising', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'trustful', word: 'trustful', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'tolerant', word: 'tolerant', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'spirited', word: 'spirited', trialtype: 'novel2', valence: 'positive', cue: 'self?'},
  {stimulus: 'bad', word: 'bad', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'wretched', word: 'wretched', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'upset', word: 'upset', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'guilty', word: 'guilty', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'deceitful', word: 'deceitful', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'ungrateful', word: 'ungrateful', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'rejected', word: 'rejected', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'unloved', word: 'unloved', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'hopeless', word: 'hopeless', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'unappreciated', word: 'unappreciated', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'superficial', word: 'superficial', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'vain', word: 'vain', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'cowardly', word: 'cowardly', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'conceited', word: 'conceited', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'greedy', word: 'greedy', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'fickle', word: 'fickle', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'antisocial', word: 'antisocial', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'ungracious', word: 'ungracious', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'disagreeable', word: 'disagreeable', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'lazy', word: 'lazy', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'unappealing', word: 'unappealing', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'crude', word: 'crude', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'unforgiving', word: 'unforgiving', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'failure', word: 'failure', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'obnoxious', word: 'obnoxious', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'passive', word: 'passive', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'insolent', word: 'insolent', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'neglectful', word: 'neglectful', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'dominating', word: 'dominating', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'foolish', word: 'foolish', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'irrational', word: 'irrational', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'maladjusted', word: 'maladjusted', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'jealous', word: 'jealous', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'distrustful', word: 'distrustful', trialtype: 'novel2', valence: 'negative', cue: 'self?'},
  {stimulus: 'scornful', word: 'scornful', trialtype: 'novel2', valence: 'negative', cue: 'self?'}
]

const w4_unique_stimuli = [
  {stimulus: 'successful', word: 'successful', trialtype: 'novel3', valence: 'positive', cue: 'self?'}, // first 30 stimuli = "core" stimuli
  {stimulus: 'terrific', word: 'terrific', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'funny', word: 'funny', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'intelligent', word: 'intelligent', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'amazing', word: 'amazing', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'entertaining', word: 'entertaining', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'fantastic', word: 'fantastic', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'wonderful', word: 'wonderful', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'beautiful', word: 'beautiful', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'happy', word: 'happy', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'great', word: 'great', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'loyal', word: 'loyal', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'cool', word: 'cool', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'joyful', word: 'joyful', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'knowledgeable', word: 'knowledgeable', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'sad', word: 'sad', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'hostile', word: 'hostile', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'burdened', word: 'burdened', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'incompetent', word: 'incompetent', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'inconsiderate', word: 'inconsiderate', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'ashamed', word: 'ashamed', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'irresponsible', word: 'irresponsible', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'bored', word: 'bored', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'mad', word: 'mad', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'lonely', word: 'lonely', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'worried', word: 'worried', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'anguished', word: 'anguished', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'fearful', word: 'fearful', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'angry', word: 'angry', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'disloyal', word: 'disloyal', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'cheerful', word: 'cheerful', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'friendly', word: 'friendly', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'compassionate', word: 'compassionate', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'kind', word: 'kind', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'surprised', word: 'surprised', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'talented', word: 'talented', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'brilliant', word: 'brilliant', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'good', word: 'good', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'best', word: 'best', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'bright', word: 'bright', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'dependable', word: 'dependable', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'generous', word: 'generous', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'pleasant', word: 'pleasant', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'attentive', word: 'attentive', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'clever', word: 'clever', trialtype: 'novel3', valence: 'positive', cue: 'self?'},
  {stimulus: 'envious', word: 'envious', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'untrustworthy', word: 'untrustworthy', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'morbid', word: 'morbid', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'obnoxious', word: 'obnoxious', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'brutal', word: 'brutal', trialtype: 'novel3', valence: 'negative', cue: 'self?'},
  {stimulus: 'shamed', word: 'shamed', trialtype: 'novel6', valence: 'negative', cue: 'self?'},
  {stimulus: 'nasty', word: 'nasty', trialtype: 'novel6', valence: 'negative', cue: 'self?'},
  {stimulus: 'inadequate', word: 'inadequate', trialtype: 'novel6', valence: 'negative', cue: 'self?'},
  {stimulus: 'helpless', word: 'helpless', trialtype: 'novel6', valence: 'negative', cue: 'self?'},
  {stimulus: 'displeased', word: 'displeased', trialtype: 'novel6', valence: 'negative', cue: 'self?'}
]

const w6_unique_stimuli = [
  {stimulus: 'successful', word: 'successful', trialtype: 'novel4', valence: 'positive', cue: 'self?'}, // first 30 stimuli = "core" stimuli
  {stimulus: 'terrific', word: 'terrific', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'funny', word: 'funny', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'intelligent', word: 'intelligent', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'amazing', word: 'amazing', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'entertaining', word: 'entertaining', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'fantastic', word: 'fantastic', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'wonderful', word: 'wonderful', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'beautiful', word: 'beautiful', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'happy', word: 'happy', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'great', word: 'great', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'loyal', word: 'loyal', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'cool', word: 'cool', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'joyful', word: 'joyful', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'knowledgeable', word: 'knowledgeable', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'sad', word: 'sad', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'hostile', word: 'hostile', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'burdened', word: 'burdened', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'incompetent', word: 'incompetent', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'inconsiderate', word: 'inconsiderate', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'ashamed', word: 'ashamed', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'irresponsible', word: 'irresponsible', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'bored', word: 'bored', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'mad', word: 'mad', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'lonely', word: 'lonely', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'worried', word: 'worried', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'anguished', word: 'anguished', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'fearful', word: 'fearful', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'angry', word: 'angry', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'disloyal', word: 'disloyal', trialtype: 'novel4', valence: 'negative', cue: 'self?'},
  {stimulus: 'adventurous', word: 'adventurous', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'gracious', word: 'gracious', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'lively', word: 'lively', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'purposeful', word: 'purposeful', trialtype: 'novel4', valence: 'positive', cue: 'self?'},
  {stimulus: 'observant', word: 'observant', trialtype: 'novel4', valence: 'positive', cue: 'self?'}
]

/* Defining SRET stimuli for each biweekly session */
switch(urlvar.sret_session) {
  case "w0":
    sret_stimuli = w0_unique_stimuli;
    break;
  case "w2":
    sret_stimuli = w2_unique_stimuli;
    break;
  case "w4":
    sret_stimuli = w4_unique_stimuli;
    break;
  case "w6":
    sret_stimuli = w6_unique_stimuli;
    break;
  default:
    sret_stimuli = w0_unique_stimuli;
}
    
/* Split by valence */
const all_pos = sret_stimuli.filter(item => item.valence === 'positive');
const all_neg = sret_stimuli.filter(item => item.valence === 'negative');

// console.log("Positive:", all_pos.length);
// console.log("Negative:", all_neg.length);

/* Randomly select 20 positive and 20 negative stimuli for 40 total 'self' trials */
const self_pos = jsPsych.randomization.sampleWithoutReplacement(all_pos, 20);
const self_neg = jsPsych.randomization.sampleWithoutReplacement(all_neg, 20);

/* Select the remaining 20 stimuli for 'caps' trials */
const remaining_pos = all_pos.filter(item => !self_pos.includes(item));
const remaining_neg = all_neg.filter(item => !self_neg.includes(item));
const caps_pos = jsPsych.randomization.sampleWithoutReplacement(remaining_pos, 10);
const caps_neg = jsPsych.randomization.sampleWithoutReplacement(remaining_neg, 10);

/* Randomly capitalize 10 negative and 10 positive for 20 capitalized 'self' trials */
const self_pos_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(20).keys()], 10);
const self_neg_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(20).keys()], 10);

const finalized_self_pos = self_pos.map((item, idx) =>
  self_pos_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase(), cue: 'self?' }
    : { ...item, cue: 'self?' }
);
const finalized_self_neg = self_neg.map((item, idx) =>
  self_neg_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase(), cue: 'self?' }
    : { ...item, cue: 'self?' }
);
const finalized_self_trials = finalized_self_pos.concat(finalized_self_neg);

/* Randomly capitalize 5 negative and 5 positive for 10 capitalized 'caps' trials */
const caps_pos_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(10).keys()], 5);
const caps_neg_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(10).keys()], 5);

const finalized_caps_pos = caps_pos.map((item, idx) =>
  caps_pos_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase(), cue: 'caps?' }
    : { ...item, cue: 'caps?' }
);
const finalized_caps_neg = caps_neg.map((item, idx) =>
  caps_neg_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase(), cue: 'caps?' }
    : { ...item, cue: 'caps?' }
);
const finalized_caps_trials = finalized_caps_pos.concat(finalized_caps_neg);
    
/* Shuffle so that no two consecutive tirals have the same cue/valence/case */
let all_trials = finalized_self_trials.concat(finalized_caps_trials);

function equalityTest(a, b) {
  return (
     a.cue === b.cue &&
     a.valence === b.valence &&
     // true if both are upper or both are not upper
     (a.stimulus === a.stimulus.toUpperCase()) === (b.stimulus === b.stimulus.toUpperCase())
   );
 }
    
all_trials = jsPsych.randomization.shuffleNoRepeats(all_trials, equalityTest);

   
/* Task Instructions */
const instructions_pg1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto; font-size: 1.2em;'>
      <p>For this task, you will see a cross on the screen. Please
      look at the cross when it appears. It will be followed by a
      single word.</p>
      <p>Each word will be paired with a cue word at the top of the screen, either <strong>"SELF?"</strong> or <strong>"CAPS?"</strong>.</p>`,
choices: ['Next'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
post_trial_gap: 0
};
    
const instructions_pg2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto; font-size: 1.2em;'>
      <p>If the cue word is <strong>"SELF?"</strong>, you will have to decide whether you think
      that the word shown could be used to describe you.</p>
      <p>If the word <strong>does</strong> describe you, tap <strong>"yes"</strong> as fast as you can.</p>
      <p>If the word <strong>does not</strong> describe you, tap <strong>"no"</strong> as fast as you can.</p>`,
choices: ['Like this.'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
post_trial_gap: 0
};
    
/* Instructions Example - Self Trial */
const instructions_ex_self = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="padding-top: 40px; margin-bottom: 130px;">
      <div style="font-size: 3em; font-weight: bold; margin-bottom: 90px;">SELF?</div>
      <div style="font-size: 3.5em; margin: 70px 0 90px 0;">+</div>
      <div style="font-size: 3em;">AWAKE</div>
    </div>
  `,
  choices: ['yes', 'no'],
  button_html: choice =>
    `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`,
  trial_duration: 5000,
  post_trial_gap: 0
};

const instructions_pg3 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto; font-size: 1.2em;'>
      <p>If the cue word is <strong>"CAPS?"</strong>, you will have to decide whether the word is written in UPPERCASE letters.</p>
      <p>If the word <strong>is</strong> written in uppercase letters, tap <strong>"yes"</strong> as fast as you can.</p>
      <p>If the word <strong>is not</strong> written in uppercase letters, tap <strong>"no"</strong> as fast as you can.</p>`,
choices: ['Like this.'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
post_trial_gap: 0
};
    
/* Instructions Example - Caps Trial */
const instructions_ex_caps = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="padding-top: 40px; margin-bottom: 130px;">
      <div style="font-size: 3em; font-weight: bold; margin-bottom: 90px;">CAPS?</div>
      <div style="font-size: 3.5em; margin: 70px 0 90px 0;">+</div>
      <div style="font-size: 3em;">AWAKE</div>
    </div>
  `,
  choices: ['yes', 'no'],
  button_html: choice =>
    `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`,
  trial_duration: 5000,
  post_trial_gap: 0
};
    
const instructions_pg4 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    var stim = `<div style='width: 85%; margin: 0 auto; font-size: 1.2em;'>
      <p></p>
      <p>The words will appear very rapidly. After you read each word, respond as quickly as you can.</p>`
  if(urlvar.sret_session === "w0" || typeof urlvar.sret_session === "undefined") {
      stim = stim + `<p>Ready to practice?</p>`
    }
  stim = stim + '</div>'
  return(stim)
},
choices: ['Begin'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
post_trial_gap: 0
};
    

/* Fixation Cross Setup */
const fixation = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<div style="font-size: 3.5em; margin-top: 60px;">+</div>',
  choices: [],
  trial_duration: function(){
    return jsPsych.randomization.sampleWithoutReplacement([600, 700, 800, 900, 1000], 1)[0];
  }
};
    
/* Retry Instructions */
const retry_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto; font-size: 1.3em; line-height: 1.4em;'>
      <p>Let's try some more!</p>
      <p>Remember, decide whether the word is written in <strong>UPPERCASE</strong> letters if the cue word is <strong>"CAPS?"</strong>.</p>
      <p>If the cue word is <strong>"SELF?"</strong>, then decide whether you think that the word shown could be <strong>used to describe you</strong>.</p>
    </div>`,
    choices: ['Continue'],
    button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
    post_trial_gap: 0
  };
    
/* Correction feedback for caps? practice trials */
const caps_correction = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    const last_trial = jsPsych.data.get().last(1).values()[0];
    const word = last_trial.word;
    const isUpper = word === word.toUpperCase();
    const caseType = isUpper ? 'uppercase' : 'lowercase';
    
    return `<div style='width: 85%; margin: 0 auto; font-size: 1.3em; line-height: 1.4em;'>
      <p><strong>"${word}"</strong> was in ${caseType} letters.</p>
      <p>Remember, if the cue word is <strong>"CAPS?"</strong>, decide whether the word is written in <strong>UPPERCASE</strong> letters.</p>
    </div>`;
  },
  choices: ['Continue'],
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 1.8em;">${choice}</button>`},
  post_trial_gap: 500
};
    
/* but only show if previous trial was caps? and incorrect */
const conditional_caps_correction = {
  timeline: [caps_correction],
  conditional_function: function(){
    const last_trial = jsPsych.data.get().last(1).values()[0];
    // Show correction if it was a caps? trial AND they got it wrong
    return (last_trial.cue === "caps?" && last_trial.correct === false);
  }
};

/* practice trial */
const practice_trial = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    const cue = jsPsych.evaluateTimelineVariable('cue').toUpperCase();
    const word = jsPsych.evaluateTimelineVariable('stimulus');
    return `
      <div style="padding-top: 40px; margin-bottom: 130px;">
        <div style="font-size: 3em; font-weight: bold; margin-bottom: 90px;">${cue}</div>
        <div style="font-size: 3.5em; margin: 70px 0 90px 0;">+</div>
        <div style="font-size: 3em;">${word}</div>
      </div>
    `;
  },
  choices: ['yes', 'no'],
  button_html: (choice) => {
    return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`;
  },
  data: {
    cue: jsPsych.timelineVariable('cue'),
    valence: jsPsych.timelineVariable('valence'),
    trialtype: jsPsych.timelineVariable('trialtype'),
    word: jsPsych.timelineVariable('word'),
  },
  on_finish: function(data){
    // For caps? trials, mark correct if answer matches case
    if(data.cue === "caps?") {
      const isUpper = data.word === data.word.toUpperCase();
      data.correct = (isUpper && data.response == 0) || (!isUpper && data.response == 1);
    } else {
      data.correct = true; // no error-check for 'self?'
    }
    data.endorse = data.response == 0;
  }
};


/* first practice round */
const practice_procedure = {
  timeline: [fixation, practice_trial, conditional_caps_correction],  // with correction
  timeline_variables: practice_stimuli,
  randomize_order: true
};

/* second practice round */
const practice_procedure_second_round = {
  timeline: [fixation, practice_trial, conditional_caps_correction],  // Added correction
  timeline_variables: practice_stimuli_second_round,
  randomize_order: true
};

/* second practice round */
const check_case_correctness = {
  timeline: [retry_instructions, practice_procedure_second_round],
  conditional_function: function(){
    const practice_data = jsPsych.data.get().filter({trialtype: 'practice'}).last(6).values();
    const case_trials = practice_data.filter(trial => trial.cue === "caps?");
    return case_trials.some(trial => trial.correct === false);
  }
};
    
/* Main Task Block */
const sret = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    const cue = jsPsych.evaluateTimelineVariable('cue').toUpperCase();
    const word = jsPsych.evaluateTimelineVariable('stimulus');
    return `
      <div style="padding-top: 40px; margin-bottom: 130px;">
        <div style="font-size: 3em; font-weight: bold; margin-bottom: 90px;">${cue}</div>
        <div style="font-size: 3.5em; margin: 70px 0 90px 0;">+</div>
        <div style="font-size: 3em;">${word}</div>
      </div>
    `;
  },
  choices: ['yes', 'no'],
  button_html: (choice) => {
    return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`;
  },
  data: {
    cue: jsPsych.timelineVariable('cue'),
    valence: jsPsych.timelineVariable('valence'),
    trialtype: jsPsych.timelineVariable('trialtype'),
    word: jsPsych.timelineVariable('word'),
  },
  on_finish: function(data){
    data.endorse = data.response == 0;
  }
};

/* Check In Block */
const check_in = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    var trials = jsPsych.data.get().filter({trialtype: 'practice'});
    var rt = Math.round(trials.select('rt').mean());
    if (rt < 300) {
      var speedcomment = "<p>It takes about half of a second to read a word. Please be sure to think about each word before responding.</p>"
    } else if (rt > 2000) {
      var speedcomment = "<p>After deciding on your answer, please respond quickly.</p>"
    } else {
      var speedcomment = "You're doing great!"
    }
    var rt = rt / 1000

    return "<div style='width: 85%; margin: 0 auto;'><p>Your average response time was "+rt+" seconds.</p>"+
      speedcomment+
      "<p>After you read each word, "+
      "quickly respond as to whether it describes you OR is capitalized.</p>"+
      "<p>To start the main task, click 'begin'.</p></div>";
  },
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
  choices: ['Begin'],
};
    
const done = {
  type: jsPsychHtmlButtonResponse,
  choices: ['Continue'],
  stimulus: `
    <div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%;">
    <p>Thank you for completing this portion of the task.</p>
    <p>Please click the "continue" button to be redirected to the next part of the study.</p>
    </div>
    `,
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
  margin_vertical: '50px',
}

/* Task Timeline */
timeline.push(instructions_pg1, instructions_pg2, instructions_ex_self, instructions_pg3, instructions_ex_caps, instructions_pg4);

timeline.push(practice_procedure);
timeline.push(check_case_correctness);
timeline.push(check_in)
    
const block_procedure = {
  timeline: [fixation, sret],
  timeline_variables: all_trials,
  randomize_order: false // already shuffled & randomized above
}

timeline.push(block_procedure);
timeline.push(done);

/* Run! */
jsPsych.run(timeline);
</script>
</html>
