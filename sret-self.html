<!DOCTYPE html>

<!--
  This version of the Self-Referent Encoding Task (SRET; Derry & Kuiper, 1981) is being used for the dissertation study of Rachel Weisenburger of the Mood Disorders Lab at UT Austin, entitled: "Depression and the Self: A Longitudinal Examination of Biased Self-Schema and Depression Symptom Dimensions." Code is adapted based on the programming of Dr. Justin Dainer-Best of the Bard College Affective Science Lab, https://affectlab.bard.edu. Incorporates the case trial condition and stimuli words from Hitchcock et al., 2023 (doi.org/10.3758/s13415-022-01033-9) and Alejandre-Lara et al., 2021 (doi.org/10.1007/s10608-021-10287-5).
-->

<html>
  <head>
    <title>Task</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
           integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
           crossorigin="anonymous"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-browser-check.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#dddddd">
  </head>
  <body></body>

<script>
// data.trials[1].session ==> the session
// data.trials[1].ppt ==> the participant ID -- the [1] just grabs it from the second trial
const jsPsych = initJsPsych({
  use_webaudio: false,
  /*on_interaction_data_update: function(data) {
    console.log('{"id": "' + urlvar.sret_id + '", "interaction: "' + JSON.stringify(data) + '}');
    //jsPsych.data.addProperties({interaction: JSON.stringify(data)})
  },*/
  on_finish: function(data) {
    var ppt = data.trials[1].ppt;
    var session = data.trials[1].session;
    var finalurl = data.trials[1].rc; // redcap_url;
    if (finalurl) {
      /*
      //finalurl = 'https://https://sret-self-4774526bcb1e.herokuapp.com/?' // just start it over if they don't have the URL
    } else {*/
      finalurl = 'https://redcap.prc.utexas.edu/redcap/surveys/?code=' + finalurl + '&' // s= for survey string; code= for access code
    }
    // create a confirmation code to send
    /*var confirmation_code = '';
    switch(session) {
      case "w0": confirmation_code = 'b5wiNTT5pp'; break;
      case "w2": confirmation_code = 'qrso6FWM0u'; break;
      case "w4": confirmation_code = 'XKFAqwTQhz'; break;
      case "w6": confirmation_code = 'NAeVQD00m8'; break;
      default: confirmation_code = 'none_provided';
    }*/
    //console.log("Posting data for ID " + ppt + " and session " + session);
    var newurlgo = `${finalurl}sret_id=${ppt}&sret_session=${session}` //`&sret_conf=${confirmation_code}`
    //jsPsych.data.displayData('csv')
    // var all_data = jsPsych.data.get();
    // get csv representation of data and log to console
    // console.log(all_data.csv());
    // console.log({...data, ...jsPsych.data.getInteractionData()})
    var jqxhr = $.post({
      url: "/experiment-data",
      data: JSON.stringify(data),
      contentType: "application/json"
    })
    .done(function(data) {
      //console.log("Succeed!")
      if(finalurl) {
        window.location.href = newurlgo;
      } else {
        // if they don't have an RC, tell them there's a problem
        document.write('<!DOCTYPE html><html><body><div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%;"><h1>Missing redirect</h1><p>This page cannot redirect you as expected. Please be sure that you followed the correct link. While your data has been recorded, you will not be redirected to finish data collection for today. You do not need to complete the task again, but may contact the researchers if you have questions.</p></div></body></html>')
      }
      //console.log("Success posting and user redirected");
    })
    .fail(function() {
      //console.log("Fail!")
      //console.log("A problem occurred while writing to the database. User redirected.")
      window.location.href = newurlgo;
    })
  }
});

const timeline = []

/* get URL variables */
var urlvar = jsPsych.data.urlVariables();

jsPsych.data.addProperties({
  ppt: urlvar.sret_id,
  session: urlvar.sret_session,
  rc: urlvar.rc
});

// console.log("ID " + urlvar.sret_id + " at session " + urlvar.sret_session + " began the task.")

// the URL is formatted as: https://redcap.prc.utexas.edu/redcap/surveys/?s=t5BVsbF5izKnIFYv
// so we need to grab the "?s=" part
//const fullurl = window.location.href;
//const redcap_url = fullurl.substring(fullurl.indexOf('?s=') + 3);
// console.log("url is " + redcap_url);


/* check to confirm that they're on mobile */
const checkMobile = {
  type: jsPsychBrowserCheck,
  features: ["mobile", "browser"],
};

//timeline.push(checkMobile);

const notifyMobile = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%; font-size: 1em; line-height: 1.2em;">
    <p>We recommend that you participate on a mobile device. If you are on a desktop or laptop, you may want to switch to your smartphone or tablet.</p>
    <p>(You can right click and copy <a href="${window.location.href}">the URL</a> from this tab to your phone.)</p>
    </div>
    `,
    choices: ['Continue'],
    button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
    margin_vertical: '50px',
};

var if_mobile = {
    timeline: [notifyMobile],
    conditional_function: function(){
        // get the data from the previous trial,
        // and check whether it's mobile or not
        var data = jsPsych.data.get().last(1).values()[0];
        // change CSS for fonts based if they're NOT on mobile:
        if(!data.mobile) {
          $('.jspsych-display-element').css('font-size', '1.5em')
          $('.jspsych-display-element').css('line-height', '1.7em')
          //dStyle.innerHTML = '.jspsych-display-element {font-family: "Open Sans", "Arial", sans-serif; font-size: 2.5em; line-height: 2em;}';
        }
        return(!data.mobile)
        /*if(data.mobile){
          return false;
        } else {
          return true;
        }*/
    }
}

timeline.push(checkMobile, if_mobile);

/* Stimuli Setup */

/* practice trials */
const practice_stimuli = [
  {stimulus: 'TALL', word: 'TALL', trialtype: 'practice', valence: 'null', cue: 'self'},
  {stimulus: 'young', word: 'young', trialtype: 'practice', valence: 'null', cue: 'case'},
  {stimulus: 'strong', word: 'strong', trialtype: 'practice', valence: 'null', cue: 'self'},
  {stimulus: 'SORE', word: 'SORE', trialtype: 'practice', valence: 'null', cue: 'case'},
  {stimulus: "cold", word: 'cold', trialtype: 'practice', valence: 'null', cue: 'self'}
];

const practice_stimuli_second_round = [
  {stimulus: 'short', word: 'short', trialtype: 'practice2', valence: 'null', cue: 'case'},
  {stimulus: 'WEAK', word: 'WEAK', trialtype: 'practice2', valence: 'null', cue: 'self'},
  {stimulus: 'STUDENT', word: 'STUDENT', trialtype: 'practice2', valence: 'null', cue: 'case'},
  {stimulus: 'sibling', word: 'sibling', trialtype: 'practice2', valence: 'null', cue: 'self'},
  {stimulus: 'warm', word: 'warm', trialtype: 'practice2', valence: 'null', cue: 'case'}
];

const base_sret_stimuli = [
  {stimulus: 'successful', word: 'successful', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'terrific', word: 'terrific', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'funny', word: 'funny', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'intelligent', word: 'intelligent', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'amazing', word: 'amazing', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'entertaining', word: 'entertaining', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'fantastic', word: 'fantastic', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'wonderful', word: 'wonderful', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'beautiful', word: 'beautiful', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'happy', word: 'happy', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'great', word: 'great', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'loyal', word: 'loyal', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'cool', word: 'cool', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'joyful', word: 'joyful', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'knowledgeable', word: 'knowledgeable', trialtype: 'core', valence: 'positive', cue: 'self'},
  {stimulus: 'sad', word: 'sad', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'hostile', word: 'hostile', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'burdened', word: 'burdened', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'incompetent', word: 'incompetent', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'inconsiderate', word: 'inconsiderate', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'ashamed', word: 'ashamed', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'irresponsible', word: 'irresponsible', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'bored', word: 'bored', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'mad', word: 'mad', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'lonely', word: 'lonely', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'worried', word: 'worried', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'anguished', word: 'anguished', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'fearful', word: 'fearful', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'angry', word: 'angry', trialtype: 'core', valence: 'negative', cue: 'self'},
  {stimulus: 'disloyal', word: 'disloyal', trialtype: 'core', valence: 'negative', cue: 'self'},
]

const w0_unique_stimuli = [
  {stimulus: 'lovable', word: 'lovable', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'glad', word: 'glad', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'nice', word: 'nice', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'satisfied', word: 'satisfied', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'thoughtful', word: 'thoughtful', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'devoted', word: 'devoted', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'capable', word: 'capable', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'handsome', word: 'handsome', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'excellent', word: 'excellent', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'excited', word: 'excited', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'useful', word: 'useful', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'sexy', word: 'sexy', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'extraordinary', word: 'extraordinary', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'honest', word: 'honest', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'loved', word: 'loved', trialtype: 'novel1', valence: 'positive', cue: 'self'},
  {stimulus: 'dreadful', word: 'dreadful', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'disgusted', word: 'disgusted', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'horrible', word: 'horrible', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'lost', word: 'lost', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'annoyed', word: 'annoyed', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'afraid', word: 'afraid', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'heartbroken', word: 'heartbroken', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'weak', word: 'weak', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'brokenhearted', word: 'brokenhearted', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'scared', word: 'scared', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'useless', word: 'useless', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'troubled', word: 'troubled', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'disgraceful', word: 'disgraceful', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'rude', word: 'rude', trialtype: 'novel1', valence: 'negative', cue: 'self'},
  {stimulus: 'dishonorable', word: 'dishonorable', trialtype: 'novel1', valence: 'negative', cue: 'self'}
]

const w2_unique_stimuli = [
  {stimulus: 'carefree', word: 'carefree', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'pleased', word: 'pleased', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'lucky', word: 'lucky', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'exciting', word: 'exciting', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'gorgeous', word: 'gorgeous', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'playful', word: 'playful', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'hopeful', word: 'hopeful', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'content', word: 'content', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'masterful', word: 'masterful', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'gentle', word: 'gentle', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'charming', word: 'charming', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'likeable', word: 'likeable', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'appreciative', word: 'appreciative', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'resourceful', word: 'resourceful', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'helpful', word: 'helpful', trialtype: 'novel2', valence: 'positive', cue: 'self'},
  {stimulus: 'bad', word: 'bad', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'wretched', word: 'wretched', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'upset', word: 'upset', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'guilty', word: 'guilty', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'deceitful', word: 'deceitful', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'ungrateful', word: 'ungrateful', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'rejected', word: 'rejected', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'unloved', word: 'unloved', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'hopeless', word: 'hopeless', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'unappreciated', word: 'unappreciated', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'superficial', word: 'superficial', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'vain', word: 'vain', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'cowardly', word: 'cowardly', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'conceited', word: 'conceited', trialtype: 'novel2', valence: 'negative', cue: 'self'},
  {stimulus: 'greedy', word: 'greedy', trialtype: 'novel2', valence: 'negative', cue: 'self'}
]

const w4_unique_stimuli = [
  {stimulus: 'cheerful', word: 'cheerful', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'friendly', word: 'friendly', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'compassionate', word: 'compassionate', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'kind', word: 'kind', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'surprised', word: 'surprised', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'talented', word: 'talented', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'brilliant', word: 'brilliant', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'good', word: 'good', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'best', word: 'best', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'bright', word: 'bright', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'dependable', word: 'dependable', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'generous', word: 'generous', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'pleasant', word: 'pleasant', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'attentive', word: 'attentive', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'clever', word: 'clever', trialtype: 'novel3', valence: 'positive', cue: 'self'},
  {stimulus: 'depressed', word: 'depressed', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'untrustworthy', word: 'untrustworthy', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'morbid', word: 'morbid', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'obnoxious', word: 'obnoxious', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'brutal', word: 'brutal', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'shamed', word: 'shamed', trialtype: 'novel6', valence: 'negative', cue: 'self'},
  {stimulus: 'nasty', word: 'nasty', trialtype: 'novel6', valence: 'negative', cue: 'self'},
  {stimulus: 'inadequate', word: 'inadequate', trialtype: 'novel6', valence: 'negative', cue: 'self'},
  {stimulus: 'helpless', word: 'helpless', trialtype: 'novel6', valence: 'negative', cue: 'self'},
  {stimulus: 'displeased', word: 'displeased', trialtype: 'novel6', valence: 'negative', cue: 'self'},
  {stimulus: 'neglectful', word: 'neglectful', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'foolish', word: 'foolish', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'boring', word: 'boring', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'sloppy', word: 'sloppy', trialtype: 'novel3', valence: 'negative', cue: 'self'},
  {stimulus: 'thoughtless', word: 'thoughtless', trialtype: 'novel3', valence: 'negative', cue: 'self'}
]

const w6_unique_stimuli = [
  {stimulus: 'vigorous', word: 'vigorous', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'adorable', word: 'adorable', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'outstanding', word: 'outstanding', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'confident', word: 'confident', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'fun', word: 'fun', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'courageous', word: 'courageous', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'unique', word: 'unique', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'optimistic', word: 'optimistic', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'admired', word: 'admired', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'skillful', word: 'skillful', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'adventurous', word: 'adventurous', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'gracious', word: 'gracious', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'lively', word: 'lively', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'purposeful', word: 'purposeful', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'observant', word: 'observant', trialtype: 'novel4', valence: 'positive', cue: 'self'},
  {stimulus: 'stupid', word: 'stupid', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'unattractive', word: 'unattractive', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'unwanted', word: 'unwanted', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'dumb', word: 'dumb', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'sorry', word: 'sorry', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'insecure', word: 'insecure', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'alone', word: 'alone', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'terrible', word: 'terrible', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'cruel', word: 'cruel', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'unlucky', word: 'unlucky', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'hateful', word: 'hateful', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'heartless', word: 'heartless', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'egotistical', word: 'egotistical', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'unsociable', word: 'unsociable', trialtype: 'novel4', valence: 'negative', cue: 'self'},
  {stimulus: 'pessimistic', word: 'pessimistic', trialtype: 'novel4', valence: 'negative', cue: 'self'},
]
    
/* Defining SRET stimuli for each biweekly session */
const stimuliMap = {
    w0: base_sret_stimuli.concat(w0_unique_stimuli),
    w2: base_sret_stimuli.concat(w2_unique_stimuli),
    w4: base_sret_stimuli.concat(w4_unique_stimuli),
    w6: base_sret_stimuli.concat(w6_unique_stimuli),
};
const selectedStimuli = stimuliMap[urlvar.sret_session] || base_sret_stimuli;
// const sret_stimuli = assignCaseTrials(selectedStimuli);

/* Split by valence */
const all_pos = selectedStimuli.filter(item => item.valence === 'positive');
const all_neg = selectedStimuli.filter(item => item.valence === 'negative');

/* Randomly select 20 positive and 20 negative stimuli for 40 total 'self' trials */
const self_pos = jsPsych.randomization.sampleWithoutReplacement(all_pos, 20);
const self_neg = jsPsych.randomization.sampleWithoutReplacement(all_neg, 20);
const self_trials = self_pos.concat(self_neg).map(item => ({ ...item, cue: 'self' }));

/* Select the remaining 20 stimuli for 'case' trials */
const remaining_pos = all_pos.filter(item => !self_pos.includes(item));
const remaining_neg = all_neg.filter(item => !self_neg.includes(item));
const case_pos = jsPsych.randomization.sampleWithoutReplacement(remaining_pos, 10);
const case_neg = jsPsych.randomization.sampleWithoutReplacement(remaining_neg, 10);
const case_trials = case_pos.concat(case_neg).map(item => ({ ...item, cue: 'case' }));

/* Randomly capitalize 10 negative and 10 positive for 20 capitalized 'self' trials */
const self_pos_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(20).keys()], 10);
const self_neg_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(20).keys()], 10);

const finalized_self_pos = self_pos.map((item, idx) =>
  self_pos_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase() }
    : item
);
const finalized_self_neg = self_neg.map((item, idx) =>
  self_neg_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase() }
    : item
);
const finalized_self_trials = finalized_self_pos.concat(finalized_self_neg);

/* Randomly capitalize 5 negative and 5 positive for 10 capitalized 'case' trials */
const case_pos_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(10).keys()], 5);
const case_neg_indices = jsPsych.randomization.sampleWithoutReplacement([...Array(10).keys()], 5);

const finalized_case_pos = case_pos.map((item, idx) =>
  case_pos_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase() }
    : item
);
const finalized_case_neg = case_neg.map((item, idx) =>
  case_neg_indices.includes(idx)
    ? { ...item, stimulus: item.stimulus.toUpperCase(), word: item.word.toUpperCase() }
    : item
);
const finalized_case_trials = finalized_case_pos.concat(finalized_case_neg);
    
/* Shuffle so that no two consecutive tirals have the same cue/valence/case */
let all_trials = finalized_self_trials.concat(finalized_case_trials);

function equalityTest(a, b) {
  return (
     a.cue === b.cue &&
     a.valence === b.valence &&
     // true if both are upper or both are not upper
     (a.stimulus === a.stimulus.toUpperCase()) === (b.stimulus === b.stimulus.toUpperCase())
   );
 }
    
all_trials = jsPsych.randomization.shuffleNoRepeats(all_trials, equalityTest);

   
/* Task Instructions */
const instructions_pg1 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto;'>
      <p>For this task, you will see a cross on the screen. Please
      look at the cross when it appears. It will be followed by a
      single word.</p>
      <p>Each word will be paired with a cue word at the top of the screen, either <strong>"self"</strong> or <strong>"case"</strong>.</p>`,
choices: ['Next'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
post_trial_gap: 2000
};
    
const instructions_pg2 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto;'>
      <p>If the cue word is <strong>"SELF"</strong>, you will have to decide whether you think
      that the word shown could be used to describe you.</p>
      <p>If the word <strong>does</strong> describe you, tap <strong>"yes"</strong> as fast as you can.</p>
      <p>If the word <strong>does not</strong> describe you, tap <strong>"no"</strong> as fast as you can.</p>`,
choices: ['Next'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
post_trial_gap: 2000
};
    
const instructions_ex_self = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
      <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 65vh;">
        <div style="margin-top: 5vh; font-size: 2.3em; font-weight: bold;">SELF</div>
        <div style="font-size: 3em; margin: 2vh 0;">+</div>
        <div style="margin-bottom: 5vh; font-size: 2.3em;">AWAKE</div>
      </div>
    `,
  choices: ['Next'],
  button_html: choice =>
    `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`,
  post_trial_gap: 2000
};
    
const instructions_pg3 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto;'>
      <p>If the cue word is <strong>"CASE"</strong>, you will have to decide whether the word is written in UPPERCASE letters.</p>
      <p>If the word <strong>is</strong> written in uppercase letters, tap <strong>"yes"</strong> as fast as you can.</p>
      <p>If the word <strong>is not</strong> written in uppercase letters, tap <strong>"no"</strong> as fast as you can.</p>`,
choices: ['Next'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
post_trial_gap: 2000
};
    
const instructions_ex_case = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
      <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 65vh;">
        <div style="margin-top: 5vh; font-size: 2.3em; font-weight: bold;">CASE</div>
        <div style="font-size: 3em; margin: 2vh 0;">+</div>
        <div style="margin-bottom: 5vh; font-size: 2.3em;">asleep</div>
      </div>
    `,
  choices: ['Next'],
  button_html: choice =>
    `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`,
  post_trial_gap: 2000
};
    
const instructions_pg4 = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    var stim = `<div style='width: 85%; margin: 0 auto;'>
      <p></p>
      <p>The words will appear very rapidly. After you read each word, respond as quickly as you can.</p>`
  if(urlvar.sret_session === "w0" || typeof urlvar.sret_session === "undefined") {
      stim = stim + `<p>Ready to practice?</p>`
    }
  stim = stim + '</div>'
  return(stim)
},
choices: ['Begin'],
button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
post_trial_gap: 2000
};
    

/* Fixation Cross Setup*/
const fixation = {
  type: jsPsychHtmlButtonResponse,
  stimulus: '<div style="font-size: 3em">+</div>',
  choices: [],
  trial_duration: function(){
    return jsPsych.randomization.sampleWithoutReplacement([600, 700, 800, 900, 1000], 1)[0];
  }
};

/* Retry Instructions */
const retry_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<div style='width: 85%; margin: 0 auto; font-size: 1.3em; line-height: 1.4em;'>
      <p>Let's try some more.</p>
      <p>Remember, if the cue word is <strong>"case"</strong>, you will have to decide whether the word is written in <strong>UPPERCASE</strong> letters.</p>
      <p>If the cue word is <strong>"self"</strong>, you will have to decide whether you think that the word shown could be used to describe you.</p>
    </div>`,
    choices: ['Continue'],
    button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
    post_trial_gap: 2000
  };

/* Practice Trial Block */
const practice_trial = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    const cue = jsPsych.evaluateTimelineVariable('cue').toUpperCase();
    const word = jsPsych.evaluateTimelineVariable('stimulus');
    return `
      <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 65vh;">
        <div style="margin-top: 5vh; font-size: 2.3em; font-weight: bold;">${cue}</div>
        <div style="font-size: 3em; margin: 2vh 0;">+</div>
        <div style="margin-bottom: 5vh; font-size: 2.3em;">${word}</div>
      </div>
    `;
  },
  choices: ['yes', 'no'],
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em; margin-top: 50px;">${choice}</button>`},
  data: {
    cue: jsPsych.timelineVariable('cue'),
    valence: jsPsych.timelineVariable('valence'),
    trialtype: jsPsych.timelineVariable('trialtype'),
    word: jsPsych.timelineVariable('word'),
  },
  on_finish: function(data){
    // For case trials, mark correct if (cue=='case' && uppercase) or (cue=='case' && !uppercase) etc.
    if(data.cue === "case") {
      const isUpper = data.word === data.word.toUpperCase();
      data.correct = (isUpper && data.response == 0) || (!isUpper && data.response == 1);
    } else {
      data.correct = true; // no error-check for 'self'
    }
    data.endorse = data.response == 0;
  }
}
    
const practice_procedure = {
  timeline: [fixation, practice_trial],
  timeline_variables: practice_stimuli,
  randomize_order: true
};

const practice_procedure_second_round = {
  timeline: [fixation, practice_trial],
  timeline_variables: practice_stimuli_second_round,
  randomize_order: true
};
    
const check_case_correctness = {
  timeline: [retry_instructions, practice_procedure_second_round],
  conditional_function: function(){
    const practice_data = jsPsych.data.get().filter({trialtype: 'practice'}).last(5).values();
    const case_trials = practice_data.filter(trial => trial.cue === "case");
    return case_trials.some(trial => trial.correct === false);
  }
};

/* Main Task Block */
const sret = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    const cue = jsPsych.evaluateTimelineVariable('cue').toUpperCase();
    const word = jsPsych.evaluateTimelineVariable('stimulus');
    return `
      <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 65vh;">
        <div style="margin-top: 5vh; font-size: 2.3em; font-weight: bold;">${cue}</div>
        <div style="font-size: 3em; margin: 2vh 0;">+</div>
        <div style="margin-bottom: 5vh; font-size: 2.3em;">${word}</div>
      </div>
    `;
  },
  choices: ['yes', 'no'],
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em; margin-top: 50px;">${choice}</button>`},
  data: {
    cue: jsPsych.timelineVariable('cue'),
    valence: jsPsych.timelineVariable('valence'),
    trialtype: jsPsych.timelineVariable('trialtype'),
    word: jsPsych.timelineVariable('word'),
  },
  on_finish: function(data){
    data.endorse = data.response == 0;
  }
}

/* Check In Block */
const check_in = {
  type: jsPsychHtmlButtonResponse,
  stimulus: function() {
    var trials = jsPsych.data.get().filter({trialtype: 'practice'});
    var rt = Math.round(trials.select('rt').mean());
    if (rt < 300) {
      var speedcomment = "<p>It takes about half of a second to read a word. Please be sure to think about each word before responding.</p>"
    } else if (rt > 2000) {
      var speedcomment = "<p>After deciding on your answer, please respond quickly.</p>"
    } else {
      var speedcomment = "You're doing great!"
    }
    var rt = rt / 1000

    return "<div style='width: 85%; margin: 0 auto;'><p>Your average response time was "+rt+" seconds.</p>"+
      speedcomment+
      "<p>After you read each word, "+
      "quickly respond as to whether it describes you or is capitalized. </p></div>";
  },
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
  choices: ['Begin'],
};
    
const done = {
  type: jsPsychHtmlButtonResponse,
  choices: ['Continue'],
  stimulus: `
    <div style="border: 2px solid black; padding: 20px; margin: 0 auto; width: 70%;">
    <p>Thank you for completing this portion of the task.</p>
    <p>Please click the "continue" button to be redirected to the next part of the study.</p>
    </div>
    `,
  button_html: (choice) => {return `<button class="jspsych-btn" style="color: #1B4D3E; font-weight: bold; font-size: 2.5em;">${choice}</button>`},
  margin_vertical: '50px',
}

/* Task Timeline */
timeline.push(instructions_pg1, instructions_pg2, instructions_ex_self, instructions_pg3, instructions_ex_case, instructions_pg4);
    
if(urlvar.sret_session === "w0" || typeof urlvar.sret_session === "undefined") {
  timeline.push(practice_procedure); // first practice block
  timeline.push(check_case_correctness); // retry practice block if they get one of the case practice trials
  timeline.push(check_in);
}

const block_procedure = {
  timeline: [fixation, sret],
  timeline_variables: all_trials,
  randomize_order: false // already shuffled & randomized above
}

timeline.push(block_procedure);
timeline.push(done);

/* Run! */
jsPsych.run(timeline);
</script>
</html>
